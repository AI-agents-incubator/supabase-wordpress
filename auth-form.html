<!--
  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  â•‘  Supabase Auth Form - Google + Facebook + Magic Link             â•‘
  â•‘  Version: 2.3 - Security Update (Open Redirect Protection)       â•‘
  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  ğŸ“– DOCUMENTATION: See docs/AUTH-FORM-REDIRECT-GUIDE.md

  ğŸš€ QUICK SETUP:
  1. Paste this code into WordPress page (HTML widget/block)
  2. Configure AUTH_CONFIG in <script> section below
  3. Done!

  ğŸ’¡ TIP: Use Settings page to configure Supabase credentials and pages
-->

<style>
  /* ========== ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  ========== */

  .sb-auth-wrapper {
    max-width: 440px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  .sb-auth-card {
    background: #ffffff;
    border-radius: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    padding: 48px 40px;
    transition: box-shadow 0.3s ease;
  }

  .sb-auth-card:hover {
    box-shadow: 0 8px 12px rgba(0, 0, 0, 0.1), 0 24px 48px rgba(0, 0, 0, 0.12);
  }

  /* ========== Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš ========== */

  .sb-auth-header {
    text-align: center;
    margin-bottom: 32px;
  }

  .sb-auth-logo {
    font-size: 32px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 8px 0;
    letter-spacing: -0.5px;
  }

  .sb-auth-tagline {
    font-size: 15px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
  }

  /* ========== Ğ­ĞšĞ ĞĞĞ« ========== */

  .sb-screen {
    display: none;
  }

  .sb-screen.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ========== ĞšĞĞĞŸĞšĞ˜ OAUTH ========== */

  .sb-oauth-section {
    margin-bottom: 24px;
  }

  .sb-oauth-btn {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    background: #ffffff;
    font-size: 15px;
    font-weight: 600;
    color: #374151;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-family: inherit;
  }

  .sb-oauth-btn:last-child {
    margin-bottom: 0;
  }

  .sb-oauth-btn:hover {
    background: #f9fafb;
    border-color: #d1d5db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .sb-oauth-btn:active {
    transform: translateY(0);
  }

  .sb-oauth-icon {
    width: 20px;
    height: 20px;
  }

  /* ========== Ğ ĞĞ—Ğ”Ğ•Ğ›Ğ˜Ğ¢Ğ•Ğ›Ğ¬ ========== */

  .sb-divider {
    display: flex;
    align-items: center;
    margin: 24px 0;
    color: #9ca3af;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .sb-divider::before,
  .sb-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #e5e7eb;
  }

  .sb-divider::before {
    margin-right: 16px;
  }

  .sb-divider::after {
    margin-left: 16px;
  }

  /* ========== EMAIL INPUT ========== */

  .sb-email-section {
    margin-bottom: 16px;
  }

  .sb-email-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 15px;
    color: #111827;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: inherit;
  }

  .sb-email-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-email-input::placeholder {
    color: #9ca3af;
  }

  /* ========== ĞšĞĞĞŸĞšĞ˜ ========== */

  .sb-btn {
    width: 100%;
    padding: 14px 16px;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: inherit;
  }

  .sb-btn-primary {
    background: #111827;
    color: #ffffff;
  }

  .sb-btn-primary:hover {
    background: #1f2937;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .sb-btn-primary:active {
    transform: translateY(0);
  }

  .sb-btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
  }

  /* ========== CHECK EMAIL SCREEN ========== */

  .sb-check-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 24px;
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .sb-check-icon svg {
    width: 32px;
    height: 32px;
    color: #3b82f6;
  }

  .sb-check-title {
    font-size: 24px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 12px 0;
    text-align: center;
  }

  .sb-check-text {
    font-size: 15px;
    color: #6b7280;
    text-align: center;
    line-height: 1.6;
    margin: 0 0 8px 0;
  }

  .sb-user-email {
    color: #111827;
    font-weight: 600;
  }

  .sb-check-instruction {
    font-size: 14px;
    color: #9ca3af;
    text-align: center;
    margin: 0 0 24px 0;
  }

  /* ========== CODE INPUT ========== */

  .sb-code-toggle {
    text-align: center;
    margin: 24px 0;
  }

  .sb-link {
    color: #3b82f6;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .sb-link:hover {
    color: #2563eb;
    text-decoration: underline;
  }

  .sb-code-section {
    display: none;
    margin-top: 24px;
  }

  .sb-code-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .sb-code-label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    text-align: center;
  }

  .sb-code-input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid #e5e7eb;
    border-radius: 12px;
    font-size: 20px;
    color: #111827;
    text-align: center;
    letter-spacing: 6px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-sizing: border-box;
    font-family: 'Courier New', monospace;
  }

  .sb-code-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .sb-code-input::placeholder {
    color: #d1d5db;
    letter-spacing: 4px;
  }

  .sb-verify-btn {
    margin-top: 12px;
  }

  /* ========== FOOTER LINKS ========== */

  .sb-footer {
    text-align: center;
    margin-top: 20px;
    font-size: 14px;
    color: #6b7280;
  }

  /* ========== Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ ========== */

  .sb-message {
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 14px;
    margin-bottom: 16px;
    text-align: center;
    display: none;
  }

  .sb-message.active {
    display: block;
  }

  .sb-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    animation: shake 0.3s ease;
  }

  .sb-success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #16a34a;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  /* ========== ĞœĞĞ‘Ğ˜Ğ›Ğ¬ĞĞĞ¯ ĞĞ”ĞĞŸĞ¢ĞĞ¦Ğ˜Ğ¯ ========== */

  @media (max-width: 480px) {
    .sb-auth-wrapper {
      padding: 16px;
    }

    .sb-auth-card {
      padding: 40px 28px;
      border-radius: 16px;
    }

    .sb-auth-logo {
      font-size: 28px;
    }

    .sb-auth-tagline {
      font-size: 14px;
    }

    .sb-oauth-btn,
    .sb-email-input,
    .sb-btn {
      padding: 12px 14px;
      font-size: 14px;
    }

    .sb-check-icon {
      width: 56px;
      height: 56px;
      margin-bottom: 20px;
    }

    .sb-check-icon svg {
      width: 28px;
      height: 28px;
    }

    .sb-check-title {
      font-size: 22px;
    }

    .sb-check-text {
      font-size: 14px;
    }
  }

  @media (max-width: 360px) {
    .sb-auth-card {
      padding: 32px 24px;
    }

    .sb-auth-logo {
      font-size: 24px;
    }
  }
</style>

<!-- Ğ¤ĞĞ ĞœĞ -->
<div class="sb-auth-wrapper">
  <div class="sb-auth-card">
    <!-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ -->
    <div class="sb-message sb-error" id="sb-error-msg"></div>
    <div class="sb-message sb-success" id="sb-success-msg"></div>

    <!-- ========== Ğ­ĞšĞ ĞĞ 1: EMAIL + OAUTH ========== -->
    <div class="sb-screen active" id="sb-screen-1">
      <!-- OAuth ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ -->
      <div class="sb-oauth-section">
        <!-- Google -->
        <button class="sb-oauth-btn" id="sb-google-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
          </svg>
          ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Google
        </button>

        <!-- Facebook -->
        <button class="sb-oauth-btn" id="sb-facebook-btn">
          <svg class="sb-oauth-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" fill="#1877F2"/>
          </svg>
          ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Facebook
        </button>
      </div>

      <!-- Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ -->
      <div class="sb-divider">Ğ¸Ğ»Ğ¸</div>

      <!-- Email Ñ„Ğ¾Ñ€Ğ¼Ğ° -->
      <form id="sb-email-form">
        <div class="sb-email-section">
          <input
            type="email"
            id="sb-email-input"
            class="sb-email-input"
            placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ email"
            required
            autocomplete="email"
          >
        </div>
        <button type="submit" class="sb-btn sb-btn-primary">
          ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ñ email
        </button>
        <p style="text-align: center; font-size: 13px; color: #6b7280; margin-top: 12px; line-height: 1.5;">
          Ğ’Ğ°Ğ¼ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ ÑĞ¾ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ¸ Ğ²Ğ°Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑÑ‚Ğ¾ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ. Ğ‘ĞµĞ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ²Ñ‹ Ğ½Ğµ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ½Ğ¸ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸, Ğ½Ğ¸ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ.
        </p>
      </form>

      <!-- ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ -->
      <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center;">
        <p style="color: #6b7280; font-size: 14px; margin: 0 0 10px 0;">
          ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ ÑĞ¾ Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ¼?
        </p>
        <a href="/login/" style="color: #2563eb; font-size: 14px; text-decoration: underline;">
          Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ ĞºĞ»Ğ°ÑÑĞ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ¼ (email + Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ)
        </a>
      </div>
    </div>

    <!-- ========== Ğ­ĞšĞ ĞĞ 2: CHECK EMAIL ========== -->
    <div class="sb-screen" id="sb-screen-2">
      <!-- Ğ˜ĞºĞ¾Ğ½ĞºĞ° -->
      <div class="sb-check-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>

      <!-- Ğ¢ĞµĞºÑÑ‚ -->
      <h3 class="sb-check-title">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ</h3>
      <p class="sb-check-text">
        Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ ÑÑÑ‹Ğ»ĞºĞµ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ½Ğ°<br>
        <span class="sb-user-email" id="sb-display-email">your@email.com</span>
      </p>
      <p class="sb-check-instruction">
        ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²Ğ¾Ğ»ÑˆĞµĞ±Ğ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ Ğ² Ğ¿Ğ¸ÑÑŒĞ¼Ğµ Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ°
      </p>

      <!-- ĞšĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ (Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ Ğ´Ğ»Ñ VPN/Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ğ¼) -->
      <div class="sb-code-toggle">
        <a class="sb-link" id="sb-show-code">ğŸ’¡ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ ÑĞ¾ Ğ²Ñ…Ğ¾Ğ´Ğ¾Ğ¼? Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ ĞºĞ¾Ğ´ Ğ¸Ğ· Ğ¿Ğ¸ÑÑŒĞ¼Ğ°</a>
      </div>

      <div class="sb-code-section" id="sb-code-section">
        <label class="sb-code-label" for="sb-code-input">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¸Ğ· Ğ¿Ğ¸ÑÑŒĞ¼Ğ°</label>
        <input
          type="text"
          id="sb-code-input"
          class="sb-code-input"
          placeholder="ĞšĞ¾Ğ´ Ğ¸Ğ· Ğ¿Ğ¸ÑÑŒĞ¼Ğ° (6 Ñ†Ğ¸Ñ„Ñ€)"
          maxlength="6"
          pattern="[0-9]{6}"
          inputmode="numeric"
        >
        <button class="sb-btn sb-btn-primary sb-verify-btn" id="sb-verify-btn">
          Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ
        </button>
      </div>

      <!-- Footer -->
      <div class="sb-footer">
        <div style="margin-bottom: 16px;">
          <strong>ĞĞµ Ğ²Ğ¸Ğ´Ğ¸Ñ‚Ğµ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ²Ğ¾ Ğ²Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ…?</strong>
        </div>
        <div style="text-align: left; font-size: 14px; line-height: 1.8;">
          <strong>1.</strong> Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ email: <span id="sb-footer-email" style="font-weight: 600;"></span><br>
          Ğ•ÑĞ»Ğ¸ Ğ°Ğ´Ñ€ĞµÑ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹, <a class="sb-link" id="sb-back-to-form">Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ</a><br><br>

          <strong>2.</strong> Ğ•ÑĞ»Ğ¸ Ğ°Ğ´Ñ€ĞµÑ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ²ĞµÑ€Ğ½Ğ¾, Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ <strong>Ğ¡Ğ¿Ğ°Ğ¼</strong>, <strong>ĞŸÑ€Ğ¾Ğ¼Ğ¾</strong>, <strong>ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ</strong>, 99% Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ñ‚Ğ°Ğ¼.<br><br>

          <strong>3.</strong> Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ğ½ĞµÑ‚, <a class="sb-link" id="sb-resend">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Supabase SDK (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼) -->
<script>
  // window.SUPABASE_CFG ÑƒĞ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼ Ñ‡ĞµÑ€ĞµĞ· wp_enqueue_scripts
  // window.supabase Ñ‚Ğ¾Ğ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼
</script>

<script>
  // ========== SUPABASE AUTH Ğ¡ Ğ£ĞœĞĞ«ĞœĞ˜ Ğ Ğ•Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞœĞ˜ ==========

  (function() {
    'use strict';

    // ========== SAFE LOCALSTORAGE WRAPPER (Safari Privacy Protection) ==========
    // Safari Ñ Enhanced Privacy Protection Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ localStorage
    // Ğ­Ñ‚Ğ¾Ñ‚ wrapper Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ fallback Ğ½Ğ° in-memory Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ
    const safeStorage = (function() {
      let memoryStorage = {}; // Fallback Ğ´Ğ»Ñ Safari Privacy mode
      let storageAvailable = false;

      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ localStorage
      try {
        const testKey = '__storage_test__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        storageAvailable = true;
        console.log('âœ… localStorage Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½');
      } catch (e) {
        console.warn('âš ï¸  localStorage Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Safari Privacy Protection, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ in-memory fallback');
        storageAvailable = false;
      }

      return {
        getItem: function(key) {
          try {
            return storageAvailable ? localStorage.getItem(key) : memoryStorage[key] || null;
          } catch (e) {
            return memoryStorage[key] || null;
          }
        },
        setItem: function(key, value) {
          try {
            if (storageAvailable) {
              localStorage.setItem(key, value);
            } else {
              memoryStorage[key] = value;
            }
          } catch (e) {
            memoryStorage[key] = value;
          }
        },
        removeItem: function(key) {
          try {
            if (storageAvailable) {
              localStorage.removeItem(key);
            } else {
              delete memoryStorage[key];
            }
          } catch (e) {
            delete memoryStorage[key];
          }
        },
        key: function(index) {
          try {
            return storageAvailable ? localStorage.key(index) : Object.keys(memoryStorage)[index] || null;
          } catch (e) {
            return Object.keys(memoryStorage)[index] || null;
          }
        },
        get length() {
          try {
            return storageAvailable ? localStorage.length : Object.keys(memoryStorage).length;
          } catch (e) {
            return Object.keys(memoryStorage).length;
          }
        }
      };
    })();
    // ========== END SAFE LOCALSTORAGE WRAPPER ==========

    // ========== CLEANUP: Clear Supabase session BEFORE form loads ==========
    // This ensures fresh login state every time user visits login page
    (function cleanupSupabaseSession() {
      try {
        // Clear all Supabase localStorage keys
        const keysToRemove = [];
        for (let i = 0; i < safeStorage.length; i++) {
          const key = safeStorage.key(i);
          if (key && (key.startsWith('sb-') || key.startsWith('sb_processed_'))) {
            keysToRemove.push(key);
          }
        }

        if (keysToRemove.length > 0) {
          console.log('ğŸ§¹ Cleaning up Supabase localStorage before login:', keysToRemove.length, 'keys');
          keysToRemove.forEach(key => safeStorage.removeItem(key));
          console.log('âœ… Supabase localStorage cleared - ready for fresh login');
        }
      } catch (e) {
        console.warn('Could not clean localStorage:', e);
      }
    })();
    // ========== END CLEANUP ==========

    // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° ĞµÑĞ»Ğ¸ DOM Ğ½Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAuthForm);
    } else {
      initAuthForm();
    }

    function initAuthForm() {
      try {
        // ========== SAVE RETURN URL FOR LOGIN FLOW ==========
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ, Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ (Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°)
        const returnUrl = document.referrer || window.location.origin + '/';
        console.log('ğŸ”— Login return URL detected:', returnUrl);
        safeStorage.setItem('login_return_url', returnUrl);

        // ========== SAVE REGISTRATION PAGE URL FOR REGISTRATION PAIRS ==========
        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ URL Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ (Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸) Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Thank You page
        const registrationPageUrl = window.location.pathname;
        console.log('ğŸ“ Registration page URL:', registrationPageUrl);
        safeStorage.setItem('registration_page_url', registrationPageUrl);

        // ========== ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ==========

        const AUTH_CONFIG = {
      // ğŸ¯ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦ Ğ‘Ğ›ĞĞ“ĞĞ”ĞĞ ĞĞĞ¡Ğ¢Ğ˜ Ğ”Ğ›Ğ¯ ĞĞĞ’Ğ«Ğ¥ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™
      //
      // ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ñ‹ (ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ²Ğ½Ğ¸Ğ·):
      // 1. URL Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ ?thank_you=/custom-page/  (Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ²ÑÑ‘)
      // 2. Mapping Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ» (referrer)
      // 3. Default ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° (fallback)
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 1 - Ğ¡Ğ¢ĞĞĞ”ĞĞ Ğ¢ĞĞ«Ğ™ (Ğ¾Ğ´Ğ½Ğ° ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ²ÑĞµÑ…):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // thankYouPages: {
      //   'default': '/thank-you/'
      // }
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 2 - ĞŸĞĞ ĞĞ«Ğ™ (Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ thank-you Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ»ĞµĞ½Ğ´Ğ¸Ğ½Ğ³Ğ¾Ğ²):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // thankYouPages: {
      //   '/landing-premium/': '/thank-you-premium/',
      //   '/landing-basic/': '/thank-you-basic/',
      //   '/webinar/': '/thank-you-webinar/',
      //   'default': '/thank-you/'
      // }
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ Ğ•Ğ–Ğ˜Ğœ 3 - Ğ“Ğ˜Ğ‘ĞšĞ˜Ğ™ (Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· URL):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ĞĞ° Ğ»ĞµĞ½Ğ´Ğ¸Ğ½Ğ³Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€:
      // <a href="/auth/?thank_you=/special-thank-you/">Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</a>
      //
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ• ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ (Ğ ĞµĞ¶Ğ¸Ğ¼ 2 - Ğ¿Ğ°Ñ€Ğ½Ñ‹Ğ¹):
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      thankYouPages: {
        'default': window.SUPABASE_CFG?.thankYouUrl || '/registr/'  // Thank You Page from Settings
      },

      // ğŸ  Ğ”Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ (ĞµÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸)
      defaultRedirect: '/',

      // â±ï¸ ĞŸĞ¾Ñ€Ğ¾Ğ³ "Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ" Ğ² Ğ¼Ğ¸Ğ»Ğ»Ğ¸ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ… (60 ÑĞµĞº = Ğ½ĞµĞ´Ğ°Ğ²Ğ½Ğ¾ Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½)
      newUserThreshold: 60000
    };

    // ========== Ğ­Ğ›Ğ•ĞœĞ•ĞĞ¢Ğ« DOM ==========

    const screen1 = document.getElementById('sb-screen-1');
    const screen2 = document.getElementById('sb-screen-2');
    const emailForm = document.getElementById('sb-email-form');
    const emailInput = document.getElementById('sb-email-input');
    const displayEmail = document.getElementById('sb-display-email');
    const googleBtn = document.getElementById('sb-google-btn');
    const facebookBtn = document.getElementById('sb-facebook-btn');
    const showCodeBtn = document.getElementById('sb-show-code');
    const codeSection = document.getElementById('sb-code-section');
    const codeInput = document.getElementById('sb-code-input');
    const verifyBtn = document.getElementById('sb-verify-btn');
    const backToFormBtn = document.getElementById('sb-back-to-form');
    const resendBtn = document.getElementById('sb-resend');
    const errorMsg = document.getElementById('sb-error-msg');
    const successMsg = document.getElementById('sb-success-msg');

    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹
    const requiredElements = {
      screen1, screen2, emailForm, emailInput, displayEmail,
      googleBtn, facebookBtn, showCodeBtn, codeSection, codeInput,
      verifyBtn, resendBtn, errorMsg, successMsg
    };

    for (const [name, element] of Object.entries(requiredElements)) {
      if (!element) {
        console.error(`âŒ Supabase Auth Form: Required element '${name}' not found!`);
        console.log('ğŸ’¡ Make sure the HTML structure is complete');
        return; // Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ±ĞµĞ· Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
      }
    }

    // ========== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ SUPABASE ==========

    let supabaseClient;
    let isInitialized = false; // Ğ¤Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

    function initSupabase() {
      // ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½ÑƒÑ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
      if (isInitialized) {
        console.log('âš ï¸ Supabase already initialized, skipping');
        return true;
      }

      if (!window.SUPABASE_CFG || !window.supabase) {
        return false;
      }

      try {
        const { createClient } = window.supabase;
        supabaseClient = createClient(
          window.SUPABASE_CFG.url,
          window.SUPABASE_CFG.anon
        );

        isInitialized = true; // ĞŸĞ¾Ğ¼ĞµÑ‡Ğ°ĞµĞ¼ ĞºĞ°Ğº Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹
        console.log('âœ… Supabase Auth initialized');
        return true;
      } catch (error) {
        console.error('Supabase init error:', error);
        showError('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Supabase');
        return false;
      }
    }

    // ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸ Ñ retry
    function waitForSupabase(callback, maxAttempts = 20) {
      let attempts = 0;

      const checkAndInit = () => {
        attempts++;

        if (window.SUPABASE_CFG && window.supabase) {
          // ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ°
          if (initSupabase()) {
            callback();
          } else {
            showError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Supabase. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ.');
          }
        } else if (attempts >= maxAttempts) {
          // ĞŸÑ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¾ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº
          showError('Supabase Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ wp-config.php Ğ¸Ğ»Ğ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.');
          console.error('âŒ SUPABASE_CFG not found after', maxAttempts, 'attempts');
          console.log('ğŸ’¡ Make sure supabase-bridge plugin is activated and wp-config.php is configured');
        } else {
          // ĞŸÑ€Ğ¾Ğ±ÑƒĞµĞ¼ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· Ñ‡ĞµÑ€ĞµĞ· 100ms
          setTimeout(checkAndInit, 100);
        }
      };

      checkAndInit();
    }

    // ========== TELEMETRY (v0.10.2) ==========
    // Async tracking to Supabase - zero impact on auth flow
    function trackTelemetry(event, data) {
      try {
        if (!window.SUPABASE_CFG) return; // Supabase not configured

        const payload = JSON.stringify({
          event: event,
          created_at: new Date().toISOString(),
          user_agent: navigator.userAgent.substring(0, 200),
          referrer: document.referrer || null,
          registration_url: window.location.pathname,
          landing_url: LANDING_URL || null,
          ...data
        });

        const url = window.SUPABASE_CFG.url + '/rest/v1/auth_telemetry';
        const headers = {
          'apikey': window.SUPABASE_CFG.anon,
          'Authorization': 'Bearer ' + window.SUPABASE_CFG.anon,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        };

        // Use fetch with keepalive (non-blocking, works even on page close)
        // Note: sendBeacon doesn't support custom headers, so we use fetch instead
        fetch(url, {
          method: 'POST',
          headers: headers,
          body: payload,
          keepalive: true
        }).catch(() => {}); // Silent fail - telemetry never breaks auth
      } catch (e) {
        // Silent fail - telemetry never breaks auth
      }
    }

    // ========== Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« Ğ Ğ•Ğ”Ğ˜Ğ Ğ•ĞšĞ¢ĞĞ’ ==========

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ» Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
    const ORIGIN_PAGE = (function() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ redirect_to (Ğ²Ñ‹ÑÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
      if (params.get('redirect_to')) {
        console.log('ğŸ¯ ORIGIN_PAGE: from ?redirect_to =', params.get('redirect_to'));
        return params.get('redirect_to');
      }

      // 2. Referrer (Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞµĞ»)
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ğ´Ğ¾Ğ¼ĞµĞ½
          if (referrerUrl.origin === window.location.origin) {
            console.log('ğŸ¯ ORIGIN_PAGE: from referrer =', referrerUrl.pathname);
            return referrerUrl.pathname;
          }
        } catch (e) {
          console.warn('Invalid referrer:', e);
        }
      }

      // 3. Fallback - Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
      console.log('ğŸ¯ ORIGIN_PAGE: fallback (current page) =', window.location.pathname);
      return window.location.pathname;
    })();

    // ========== LANDING URL TRACKING (v0.10.0) ==========

    // Clean advertising tracking parameters from URL (fbclid, gclid, etc.)
    function cleanTrackingParams(url) {
      if (!url) return null;

      try {
        const urlObj = new URL(url, window.location.origin);
        const trackingParams = ['fbclid', 'gclid', 'msclkid', 'gbraid', 'wbraid'];

        trackingParams.forEach(param => {
          urlObj.searchParams.delete(param);
        });

        // Return pathname + clean search params
        return urlObj.pathname + urlObj.search;
      } catch (e) {
        console.warn('Failed to clean tracking params:', e);
        return url;
      }
    }

    // Save landing URL (where user first arrived) for marketing analytics
    const LANDING_URL = (function() {
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          // Only save if same domain
          if (referrerUrl.origin === window.location.origin) {
            const cleaned = cleanTrackingParams(document.referrer);
            console.log('ğŸ“Š LANDING_URL (cleaned):', cleaned);
            return cleaned;
          } else {
            console.log('ğŸ“Š LANDING_URL: external referrer, not tracking');
            return null;
          }
        } catch (e) {
          console.warn('Invalid landing referrer:', e);
          return null;
        }
      }

      // No referrer - user came directly to auth form
      console.log('ğŸ“Š LANDING_URL: none (direct auth form access)');
      return null;
    })();

    // Security: Validate redirect URL to prevent open redirect attacks
    function isSafeRedirect(url) {
      if (!url) return false;

      // Allow relative paths (start with /)
      if (url.startsWith('/')) return true;

      // Check if URL is on same domain
      try {
        const urlObj = new URL(url, window.location.origin);
        return urlObj.origin === window.location.origin;
      } catch (e) {
        console.warn('Invalid redirect URL:', url);
        return false;
      }
    }

    function getReturnUrl() {
      // Ğ•ÑĞ»Ğ¸ origin page = Ñ‚ĞµĞºÑƒÑ‰Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° â†’ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ defaultRedirect (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ loop)
      if (ORIGIN_PAGE === window.location.pathname) {
        console.log('âš ï¸ ORIGIN_PAGE is current page, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      // Ğ”Ğ»Ñ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ¾Ñ‚ĞºÑƒĞ´Ğ° Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¸
      // Security: validate before returning
      if (!isSafeRedirect(ORIGIN_PAGE)) {
        console.warn('âš ï¸ Unsafe redirect detected, using defaultRedirect');
        return AUTH_CONFIG.defaultRedirect;
      }
      return ORIGIN_PAGE;
    }

    function getThankYouPage() {
      const params = new URLSearchParams(window.location.search);

      // 1. Explicit Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ thank_you (Ğ²Ñ‹ÑÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
      const customPage = params.get('thank_you');
      if (customPage) {
        // Security: validate custom page parameter
        if (!isSafeRedirect(customPage)) {
          console.warn('âš ï¸ Unsafe thank_you parameter detected, using default');
          return AUTH_CONFIG.thankYouPages.default;
        }
        return customPage;
      }

      // === Phase 5: Use page-specific pairs from Settings ===
      // 2a. Check registration pairs from Settings (wp_options â†’ Supabase â†’ JavaScript)
      if (window.SUPABASE_CFG?.registrationPairs && Array.isArray(window.SUPABASE_CFG.registrationPairs)) {
        const pair = window.SUPABASE_CFG.registrationPairs.find(
          p => p.registration_url === ORIGIN_PAGE
        );

        if (pair && pair.thankyou_url) {
          console.log('âœ… Phase 5: Found pair for', ORIGIN_PAGE, 'â†’', pair.thankyou_url);
          return pair.thankyou_url;
        }
      }

      // 2b. Fallback: Legacy hardcoded mapping (for backward compatibility)
      if (AUTH_CONFIG.thankYouPages[ORIGIN_PAGE]) {
        console.log('âš ï¸ Using legacy hardcoded mapping for', ORIGIN_PAGE);
        return AUTH_CONFIG.thankYouPages[ORIGIN_PAGE];
      }

      // 3. Default fallback (global Thank You Page from Settings)
      console.log('â„¹ï¸ No specific pair found, using global default:', AUTH_CONFIG.thankYouPages.default);
      return AUTH_CONFIG.thankYouPages.default;
    }

    function isNewUser(user) {
      if (!user || !user.created_at) return false;

      const createdAt = new Date(user.created_at);
      const now = new Date();
      const diff = now - createdAt;

      return diff < AUTH_CONFIG.newUserThreshold;
    }

    // ========== EMAIL MAGIC LINK ==========

    let isEmailSubmitting = false;

    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();

      if (!email) return;

      if (!supabaseClient) {
        showError('Supabase ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...');
        return;
      }

      // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞºĞ¾Ğ²
      if (isEmailSubmitting) {
        console.log('âš ï¸ Already submitting, ignoring duplicate click');
        return;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ĞšĞ›ĞĞ¡Ğ¡ 2: Cooldown Protection (v0.10.5)
      // ĞŸÑ€ĞµĞ´Ğ¾Ñ‚Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Magic Link
      // ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞºĞ»Ğ¸ĞºĞ°ĞµÑ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ· â†’ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ 5 Ğ¿Ğ¸ÑĞµĞ¼ â†’ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ñ€Ğ¾Ğµ
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const cooldownKey = 'sb_magic_link_cooldown';
      const lastSend = safeStorage.getItem(cooldownKey);
      const now = Date.now();

      if (lastSend && (now - parseInt(lastSend)) < 60000) {
        const remaining = Math.ceil((60000 - (now - parseInt(lastSend))) / 1000);
        showError(`â±ï¸ ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ ${remaining} ÑĞµĞº. Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹. Ğ’Ğ« Ğ£Ğ–Ğ• Ğ—ĞĞŸĞ ĞĞ¡Ğ˜Ğ›Ğ˜ ĞŸĞ˜Ğ¡Ğ¬ĞœĞ! ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ (Ğ¡Ğ¿Ğ°Ğ¼, ĞŸÑ€Ğ¾Ğ¼Ğ¾). ĞšĞ°Ğ¶Ğ´Ğ°Ñ Ğ½Ğ¾Ğ²Ğ°Ñ ÑÑÑ‹Ğ»ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ğµ!`);
        console.log('ğŸ›¡ï¸ Magic Link cooldown active:', remaining, 'seconds remaining');
        return;
      }

      console.log('ğŸ¯ User submitted email for magic link');

      try {
        // Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ loading
        isEmailSubmitting = true;
        const submitBtn = emailForm.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼...';
          submitBtn.style.opacity = '0.6';
        }

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° magic link Ñ registration_url + landing_url Ğ² URL (Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ°Ğ¼Ğ¸)
        const currentPage = window.location.pathname;
        let callbackWithParam = '{{CALLBACK_URL}}?registration_url=' + encodeURIComponent(currentPage);

        // Add landing_url if available (v0.10.0 - marketing tracking)
        if (LANDING_URL) {
          callbackWithParam += '&landing_url=' + encodeURIComponent(LANDING_URL);
          console.log('ğŸ“Š Magic Link includes landing_url:', LANDING_URL);
        }

        const { error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: callbackWithParam
          }
        });

        if (error) throw error;

        // Track telemetry: MagicLink requested (v0.10.2)
        trackTelemetry('magic_link_requested', {
          email: email,
          provider: 'magic_link'
        });

        // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ timestamp Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´Ğ»Ñ cooldown (v0.10.5)
        safeStorage.setItem(cooldownKey, now.toString());
        console.log('âœ… Magic Link sent - cooldown activated (60 seconds)');

        // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½ 2 (ÑÑ€Ğ°Ğ·Ñƒ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºÑ€Ğ°Ğ½ Ğ±ĞµĞ· Ğ¼Ğ¸Ğ³Ğ°Ğ½Ğ¸Ñ)
        displayEmail.textContent = email;

        // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ email Ğ² footer Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        const footerEmail = document.getElementById('sb-footer-email');
        if (footerEmail) {
          footerEmail.textContent = email;
        }

        switchScreen(2);

      } catch (error) {
        console.error('Magic link error:', error);
        showError(error.message || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ğ»ÑˆĞµĞ±Ğ½ÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ');

        // Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
        const submitBtn = emailForm.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          submitBtn.style.opacity = '1';
        }
        isEmailSubmitting = false;
      }
    });

    // ========== GOOGLE OAUTH ==========

    let isGoogleSubmitting = false;

    googleBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...');
        return;
      }

      // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞºĞ¾Ğ²
      if (isGoogleSubmitting) {
        console.log('âš ï¸ Google OAuth already in progress, ignoring duplicate click');
        return;
      }

      console.log('ğŸ¯ User clicked Google OAuth button');

      try {
        // Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
        isGoogleSubmitting = true;
        const originalText = googleBtn.textContent;
        googleBtn.disabled = true;
        googleBtn.textContent = 'ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼...';
        googleBtn.style.opacity = '0.6';

        // Save landing_url to localStorage for OAuth flow (v0.10.0)
        if (LANDING_URL) {
          safeStorage.setItem('sb_landing_url', LANDING_URL);
          console.log('ğŸ“Š Saved landing_url to localStorage for OAuth:', LANDING_URL);
        }

        const { error } = await supabaseClient.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: '{{CALLBACK_URL}}'
          }
        });

        if (error) throw error;

        // Track telemetry: OAuth requested (v0.10.2)
        trackTelemetry('oauth_requested', {
          provider: 'google'
        });

        // Ğ£ÑĞ¿ĞµÑ… - Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ Ğ½Ğ° Google, ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğµ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° OAuth Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸');

        // Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
        googleBtn.disabled = false;
        googleBtn.textContent = originalText;
        googleBtn.style.opacity = '1';
        isGoogleSubmitting = false;
      }
    });

    // ========== FACEBOOK OAUTH ==========

    let isFacebookSubmitting = false;

    facebookBtn.addEventListener('click', async () => {
      if (!supabaseClient) {
        showError('Supabase ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...');
        return;
      }

      // Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… ĞºĞ»Ğ¸ĞºĞ¾Ğ²
      if (isFacebookSubmitting) {
        console.log('âš ï¸ Facebook OAuth already in progress, ignoring duplicate click');
        return;
      }

      console.log('ğŸ¯ User clicked Facebook OAuth button');

      try {
        // Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
        isFacebookSubmitting = true;
        const originalText = facebookBtn.textContent;
        facebookBtn.disabled = true;
        facebookBtn.textContent = 'ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼...';
        facebookBtn.style.opacity = '0.6';

        // Save landing_url to localStorage for OAuth flow (v0.10.0)
        if (LANDING_URL) {
          safeStorage.setItem('sb_landing_url', LANDING_URL);
          console.log('ğŸ“Š Saved landing_url to localStorage for OAuth:', LANDING_URL);
        }

        const { error} = await supabaseClient.auth.signInWithOAuth({
          provider: 'facebook',
          options: {
            redirectTo: '{{CALLBACK_URL}}',
            scopes: 'email public_profile'
          }
        });

        if (error) throw error;

        // Track telemetry: OAuth requested (v0.10.2)
        trackTelemetry('oauth_requested', {
          provider: 'facebook'
        });

        // Ğ£ÑĞ¿ĞµÑ… - Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ Ğ½Ğ° Facebook, ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğµ Ñ€Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼

      } catch (error) {
        console.error('OAuth error:', error);
        showError(error.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° OAuth Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸');

        // Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
        facebookBtn.disabled = false;
        facebookBtn.textContent = originalText;
        facebookBtn.style.opacity = '1';
        isFacebookSubmitting = false;
      }
    });

    // ========== VERIFICATION CODE ==========

    showCodeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      codeSection.classList.add('active');
      showCodeBtn.style.display = 'none';
      codeInput.focus();
    });

    let isCodeSubmitting = false;

    verifyBtn.addEventListener('click', async () => {
      const email = displayEmail.textContent;
      const code = codeInput.value.trim();

      if (code.length !== 6) {
        showError('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ 6-Ğ·Ğ½Ğ°Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´');
        return;
      }

      if (!supabaseClient) {
        showError('Supabase ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...');
        return;
      }

      if (isCodeSubmitting) {
        console.log('âš ï¸ Verification code already submitting, ignoring duplicate click');
        return;
      }

      let shouldRestoreButton = true;
      const originalText = verifyBtn.textContent;

      try {
        isCodeSubmitting = true;
        verifyBtn.disabled = true;
        verifyBtn.textContent = 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼...';
        verifyBtn.style.opacity = '0.6';

        const { data, error } = await supabaseClient.auth.verifyOtp({
          email: email,
          token: code,
          type: 'email'
        });

        if (error) throw error;

        // Opera VPN Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ²Ğ¸ÑĞ½ÑƒÑ‚ÑŒ Ğ½Ğ° magic link verify redirect.
        // Ğ”Ğ»Ñ code flow Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· callback Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°Ğ¼Ğ¸ ÑĞµÑÑĞ¸Ğ¸.
        let session = data?.session || null;
        if (!session) {
          const { data: sessionData } = await supabaseClient.auth.getSession();
          session = sessionData?.session || null;
        }

        if (!session || !session.access_token) {
          throw new Error('ĞšĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½, Ğ½Ğ¾ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ÑĞµÑÑĞ¸Ñ. ĞÑ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ VPN Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.');
        }

        const currentPage = window.location.pathname;
        let callbackWithParam = '{{CALLBACK_URL}}?registration_url=' + encodeURIComponent(currentPage);
        if (LANDING_URL) {
          callbackWithParam += '&landing_url=' + encodeURIComponent(LANDING_URL);
        }

        const hashParams = new URLSearchParams();
        hashParams.set('access_token', session.access_token);
        hashParams.set('token_type', session.token_type || 'bearer');
        if (session.refresh_token) {
          hashParams.set('refresh_token', session.refresh_token);
        }

        showSuccess('ĞšĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ñ‘Ğ½. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ²Ñ…Ğ¾Ğ´...');
        shouldRestoreButton = false;
        window.location.href = callbackWithParam + '#' + hashParams.toString();

      } catch (error) {
        console.error('Verification error:', error);
        showError(error.message || 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ');
      } finally {
        if (shouldRestoreButton) {
          verifyBtn.disabled = false;
          verifyBtn.textContent = originalText;
          verifyBtn.style.opacity = '1';
          isCodeSubmitting = false;
        }
      }
    });

    // ========== BACK TO FORM (Ğ½ĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ) ==========

    // ĞŸÑƒĞ½ĞºÑ‚ 1: Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ° Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ´Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ñ€ĞµÑĞ°
    if (backToFormBtn) {
      backToFormBtn.addEventListener('click', (e) => {
        e.preventDefault();
        switchScreen(1); // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½ 1 (Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ²Ğ²Ğ¾Ğ´Ğ°)
        emailInput.value = ''; // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ
        emailInput.focus(); // Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
      });
    }

    // ========== RESEND (Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ½Ğ° Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ğ°Ğ´Ñ€ĞµÑ) ==========

    // ĞŸÑƒĞ½ĞºÑ‚ 3: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ½Ğ° Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Ğ°Ğ´Ñ€ĞµÑ
    if (resendBtn) {
      resendBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = displayEmail.textContent;

        if (!supabaseClient) {
          showError('Supabase ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ...');
          return;
        }

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ cooldown (60 ÑĞµĞºÑƒĞ½Ğ´)
        const lastResendKey = 'sb_last_resend';
        const lastResend = localStorage.getItem(lastResendKey);
        const now = Date.now();

        if (lastResend && (now - parseInt(lastResend)) < 60000) {
          const remaining = Math.ceil((60000 - (now - parseInt(lastResend))) / 1000);
          showError(`ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ ${remaining} ÑĞµĞºÑƒĞ½Ğ´ Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹`);
          return;
        }

        try {
          // Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ
          const originalText = resendBtn.textContent;
          resendBtn.disabled = true;
          resendBtn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼...';
          resendBtn.style.opacity = '0.6';

          // ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ Ñ‚ĞµĞ¼ Ğ¶Ğµ registration_url
          const currentPage = window.location.pathname;
          const callbackWithParam = '{{CALLBACK_URL}}?registration_url=' + encodeURIComponent(currentPage);

          const { error } = await supabaseClient.auth.signInWithOtp({
            email: email,
            options: {
              emailRedirectTo: callbackWithParam
            }
          });

          if (error) throw error;

          // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ timestamp Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
          localStorage.setItem(lastResendKey, now.toString());

          showSuccess('âœ… ĞŸĞ¸ÑÑŒĞ¼Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾! Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ¡ĞĞœĞĞ• ĞĞĞ’ĞĞ• Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾. Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚.');

          // Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€ cooldown (60 ÑĞµĞºÑƒĞ½Ğ´)
          let countdown = 60;
          resendBtn.textContent = `ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ ${countdown}Ñ`;

          const timer = setInterval(() => {
            countdown--;
            if (countdown > 0) {
              resendBtn.textContent = `ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ ${countdown}Ñ`;
            } else {
              clearInterval(timer);
              resendBtn.textContent = originalText;
              resendBtn.disabled = false;
              resendBtn.style.opacity = '1';
            }
          }, 1000);

        } catch (error) {
          console.error('Resend error:', error);
          showError(error.message || 'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¸ÑÑŒĞ¼Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾');

          // Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
          resendBtn.disabled = false;
          resendBtn.textContent = 'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·';
          resendBtn.style.opacity = '1';
        }
      });
    }

    // ========== Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« UI ==========

    function switchScreen(num) {
      screen1.classList.remove('active');
      screen2.classList.remove('active');

      if (num === 1) screen1.classList.add('active');
      if (num === 2) screen2.classList.add('active');
    }

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.add('active');
      setTimeout(() => errorMsg.classList.remove('active'), 5000);
    }

    function showSuccess(message) {
      successMsg.textContent = message;
      successMsg.classList.add('active');
      setTimeout(() => successMsg.classList.remove('active'), 3000);
    }

    // ========== Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ==========

    // Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ SUPABASE_CFG Ğ¸ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼
    waitForSupabase(() => {
      console.log('ğŸ¯ Ready to authenticate');
    });

    // ========== GLOBAL API ==========

    window.sbAuth = {
      switchScreen,
      showError,
      showSuccess,
      reset: () => {
        emailInput.value = '';
        codeInput.value = '';
        codeSection.classList.remove('active');
        showCodeBtn.style.display = '';
        switchScreen(1);
      },
      config: AUTH_CONFIG,
      client: supabaseClient
    };

      } catch (error) {
        console.error('âŒ Supabase Auth Form initialization error:', error);
        console.log('ğŸ’¡ Check browser console for details');
        // ĞĞµ Ğ¿Ñ€Ğ¾Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ´Ğ°Ğ»ÑŒÑˆĞµ - Ğ¿ÑƒÑÑ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
      }
    } // end of initAuthForm()
  })(); // end of IIFE
</script>

<!--
  Ğ“ĞĞ¢ĞĞ’Ğ:
  âœ… Supabase SDK Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ
  âœ… Magic Link (signInWithOtp)
  âœ… Verification Code
  âœ… Google OAuth
  âœ… Ğ£Ğ¼Ğ½Ñ‹Ğµ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ñ‹ (Ğ½Ğ¾Ğ²Ñ‹Ğ¹ vs ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹)
  âœ… ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ thank you pages
  âœ… WordPress ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

  ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ:
  Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸ AUTH_CONFIG.thankYouPages Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ¸Ñ… ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†!
-->
