<!--
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Supabase Authentication Callback Handler
  For /test-no-elem-2/ page

  Instructions:
  1. Edit /test-no-elem-2/ page in WordPress
  2. Switch to HTML/Code editor
  3. Paste this entire code
  4. Save and publish
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->

<!-- INSTANT LOADING SCREEN (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –°–†–ê–ó–£, —É–±–∏—Ä–∞–µ—Ç –±–µ–ª—ã–π —ç–∫—Ä–∞–Ω) -->
<style>
  #instant-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #instant-loader.hidden {
    display: none;
  }

  .instant-dots {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    justify-content: center;
  }

  .instant-dot {
    width: 12px;
    height: 12px;
    background: #667eea;
    border-radius: 50%;
    animation: instant-bounce 1.4s infinite ease-in-out both;
  }

  .instant-dot:nth-child(1) {
    animation-delay: -0.32s;
  }

  .instant-dot:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes instant-bounce {
    0%, 80%, 100% {
      transform: scale(0);
    }
    40% {
      transform: scale(1);
    }
  }
</style>

<div id="instant-loader">
  <div style="text-align: center;">
    <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
    <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    <div class="instant-dots">
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
      <div class="instant-dot"></div>
    </div>
  </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ (—Å–∫—Ä—ã—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ instant loader) -->
<style>
  .auth-callback-container {
    display: none; /* –°–∫—Ä—ã—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ instant loader */
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 480px;
    margin: 60px auto;
    padding: 48px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 20px 40px rgba(0, 0, 0, 0.08);
    text-align: center;
  }

  .auth-spinner {
    width: 48px;
    height: 48px;
    margin: 0 auto 24px;
    border: 4px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: auth-spin 1s linear infinite;
  }

  @keyframes auth-spin {
    to { transform: rotate(360deg); }
  }

  .auth-status {
    font-size: 18px;
    color: #374151;
    margin: 24px 0;
    line-height: 1.6;
  }

  .auth-status.success {
    color: #16a34a;
    font-weight: 600;
  }

  .auth-status.error {
    color: #dc2626;
    font-weight: 600;
    background: #fef2f2;
    padding: 16px;
    border-radius: 8px;
  }

  .auth-debug {
    background: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    margin: 16px 0;
    font-size: 13px;
    text-align: left;
    font-family: 'Courier New', monospace;
    max-height: 300px;
    overflow-y: auto;
    display: none;
  }

  .auth-retry {
    margin-top: 24px;
  }

  .auth-retry a {
    color: #3b82f6;
    text-decoration: underline;
    font-weight: 500;
  }

  /* ========== HELP MODAL (v0.10.5) ========== */
  .auth-help-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 100000;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }

  .auth-help-modal.active {
    display: flex;
  }

  .auth-help-content {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    position: relative;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .auth-help-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    background: #f3f4f6;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    line-height: 32px;
    color: #6b7280;
    transition: all 0.2s;
  }

  .auth-help-close:hover {
    background: #e5e7eb;
    color: #111827;
  }

  .auth-help-title {
    font-size: 22px;
    font-weight: 700;
    color: #111827;
    margin: 0 0 20px 0;
    padding-right: 40px;
  }

  .auth-help-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid #e5e7eb;
  }

  .auth-help-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .auth-help-subtitle {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 12px 0;
  }

  .auth-help-text {
    font-size: 14px;
    color: #6b7280;
    line-height: 1.6;
    margin: 0 0 12px 0;
  }

  .auth-help-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .auth-help-list li {
    font-size: 14px;
    color: #374151;
    line-height: 1.6;
    margin-bottom: 8px;
    padding-left: 24px;
    position: relative;
  }

  .auth-help-list li:before {
    content: "‚Üí";
    position: absolute;
    left: 0;
    color: #3b82f6;
    font-weight: 600;
  }

  .auth-help-warning {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 12px 16px;
    border-radius: 8px;
    margin: 12px 0;
  }

  .auth-help-warning-text {
    font-size: 14px;
    color: #92400e;
    margin: 0;
    line-height: 1.5;
  }

  .auth-help-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }

  .auth-help-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
    text-align: center;
  }

  .auth-help-btn-primary {
    background: #2563eb;
    color: white;
  }

  .auth-help-btn-primary:hover {
    background: #1d4ed8;
  }

  .auth-help-btn-secondary {
    background: #f3f4f6;
    color: #374151;
  }

  .auth-help-btn-secondary:hover {
    background: #e5e7eb;
  }

  @media (max-width: 640px) {
    .auth-help-content {
      max-width: calc(100% - 32px);
      padding: 24px;
      margin: 16px;
    }

    .auth-help-actions {
      flex-direction: column;
    }
  }
</style>

<div class="auth-callback-container">
  <div class="auth-spinner" id="authSpinner"></div>
  <div class="auth-status" id="authStatus">‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–∂–∫–æ... (5)</div>
  <div class="auth-debug" id="authDebug"></div>
  <div class="auth-retry" id="authRetry" style="display: none;">
    <a href="/">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>
</div>

<!-- ========== HELP MODAL (v0.10.5) ========== -->
<div class="auth-help-modal" id="auth-help-modal">
  <div class="auth-help-content">
    <button class="auth-help-close" id="auth-help-close">√ó</button>
    <div id="auth-help-body">
      <!-- Dynamic content will be inserted here -->
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Safe localStorage wrapper (Safari Privacy Protection)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const safeStorage = (function() {
    let memoryStorage = {}; // Fallback –¥–ª—è Safari Privacy mode
    let storageAvailable = false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ localStorage
    try {
      const testKey = '__storage_test__';
      localStorage.setItem(testKey, 'test');
      localStorage.removeItem(testKey);
      storageAvailable = true;
    } catch (e) {
      console.warn('‚ö†Ô∏è  localStorage –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Safari Privacy Protection, –∏—Å–ø–æ–ª—å–∑—É–µ–º in-memory fallback');
      storageAvailable = false;
    }

    return {
      getItem: function(key) {
        try {
          return storageAvailable ? localStorage.getItem(key) : memoryStorage[key] || null;
        } catch (e) {
          return memoryStorage[key] || null;
        }
      },
      setItem: function(key, value) {
        try {
          if (storageAvailable) {
            localStorage.setItem(key, value);
          } else {
            memoryStorage[key] = value;
          }
        } catch (e) {
          memoryStorage[key] = value;
        }
      },
      removeItem: function(key) {
        try {
          if (storageAvailable) {
            localStorage.removeItem(key);
          } else {
            delete memoryStorage[key];
          }
        } catch (e) {
          delete memoryStorage[key];
        }
      }
    };
  })();

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Configuration
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const CONFIG = {
    DEBUG_MODE: false,          // Set to true to see debug info
    THANK_YOU_PAGE: '/registr/', // Default thank you page for new users
    DEFAULT_REDIRECT: '/',       // Fallback for existing users
    NEW_USER_THRESHOLD: 60000    // 60 seconds to consider "new user"
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // DOM Elements
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  const spinner = document.getElementById('authSpinner');
  const status = document.getElementById('authStatus');
  const debugPanel = document.getElementById('authDebug');
  const retryPanel = document.getElementById('authRetry');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Telemetry (v0.10.2)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function trackTelemetry(event, data) {
    try {
      console.log('üìä trackTelemetry called:', event, data);

      if (!window.SUPABASE_CFG) {
        console.warn('‚ö†Ô∏è SUPABASE_CFG not found - telemetry disabled');
        return Promise.resolve(); // Supabase not configured
      }

      const urlParams = new URLSearchParams(window.location.search);
      const payload = JSON.stringify({
        event: event,
        created_at: new Date().toISOString(),
        user_agent: navigator.userAgent.substring(0, 200),
        referrer: document.referrer || null,
        registration_url: urlParams.get('registration_url') || null,
        landing_url: urlParams.get('landing_url') || safeStorage.getItem('sb_landing_url') || null,
        ...data
      });

      const url = window.SUPABASE_CFG.url + '/rest/v1/auth_telemetry';
      console.log('üì§ Sending telemetry to:', url);

      // Use fetch with keepalive (non-blocking, works even on page close)
      // Note: sendBeacon doesn't support custom headers, so we use fetch instead
      return fetch(url, {
        method: 'POST',
        headers: {
          'apikey': window.SUPABASE_CFG.anon,
          'Authorization': 'Bearer ' + window.SUPABASE_CFG.anon,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: payload,
        keepalive: true
      }).then(res => {
        console.log('‚úÖ Telemetry sent successfully:', event, res.status);
        return res;
      }).catch(err => {
        console.error('‚ùå Telemetry fetch failed:', event, err);
      }); // Silent fail - telemetry never breaks auth
    } catch (e) {
      console.error('‚ùå Telemetry error:', e);
      // Silent fail - telemetry never breaks auth
      return Promise.resolve();
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Utility Functions
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function debug(message, data = null) {
    console.log('[Auth Callback]', message, data || '');

    if (CONFIG.DEBUG_MODE) {
      debugPanel.style.display = 'block';
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      if (data) {
        line.textContent += ': ' + (typeof data === 'object' ? JSON.stringify(data) : data);
      }
      debugPanel.appendChild(line);
    }
  }

  function updateStatus(message, type = 'normal') {
    status.textContent = message;
    status.className = 'auth-status';

    if (type === 'success') {
      status.classList.add('success');
      spinner.style.display = 'none';
    } else if (type === 'error') {
      status.classList.add('error');
      spinner.style.display = 'none';
      retryPanel.style.display = 'block';
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Help Modal System (v0.10.5)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function showHelpModal(type, errorData = {}) {
    const modal = document.getElementById('auth-help-modal');
    const body = document.getElementById('auth-help-body');
    const closeBtn = document.getElementById('auth-help-close');

    if (!modal || !body || !closeBtn) return;

    // Generate modal content based on error type
    const content = getHelpContent(type, errorData);
    body.innerHTML = content;

    // Show modal
    modal.classList.add('active');

    // Close handlers
    closeBtn.onclick = () => modal.classList.remove('active');
    modal.onclick = (e) => {
      if (e.target === modal) modal.classList.remove('active');
    };
  }

  function getHelpContent(type, errorData) {
    const templates = {
      'facebook_email': `
        <h3 class="auth-help-title">‚ùå Facebook –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª email</h3>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</p>
          <ul class="auth-help-list">
            <li>Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –≤ –≤–∞—à–µ–º Facebook –∞–∫–∫–∞—É–Ω—Ç–µ</li>
            <li>–í—ã –æ—Ç–∫–∞–∑–∞–ª–∏ –≤ –¥–æ—Å—Ç—É–ø–µ –∫ email –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</li>
            <li>–í Facebook –∞–∫–∫–∞—É–Ω—Ç–µ –Ω–µ —É–∫–∞–∑–∞–Ω email</li>
          </ul>
        </div>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</p>
          <ul class="auth-help-list">
            <li>–ó–∞–π–¥–∏—Ç–µ –≤ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Facebook ‚Üí –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</strong> –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</li>
            <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ <strong>Google</strong> (–æ–±—ã—á–Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ)</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</strong> (email + –ø–∞—Ä–æ–ª—å)</li>
          </ul>
        </div>

        <div class="auth-help-warning">
          <p class="auth-help-warning-text">
            <strong>–°–æ–≤–µ—Ç:</strong> –ï—Å–ª–∏ –≤—ã –∏–∑ –†–æ—Å—Å–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ VPN, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –µ–≥–æ –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ VPN-—Å–µ—Ä–≤–µ—Ä—ã –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è Facebook.
          </p>
        </div>

        <div class="auth-help-actions">
          <a href="/login/" class="auth-help-btn auth-help-btn-primary">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</a>
          <button class="auth-help-btn auth-help-btn-secondary" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
      `,

      'otp_expired': `
        <h3 class="auth-help-title">‚è±Ô∏è –°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —É—Å—Ç–∞—Ä–µ–ª–∞</h3>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</p>
          <ul class="auth-help-list">
            <li>–í—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ —Å—Å—ã–ª–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî <strong>—Å—Ç–∞—Ä—ã–µ —Å—Å—ã–ª–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è</strong></li>
            <li>–ü—Ä–æ—à–ª–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏—Å—å–º–∞</li>
            <li>–í—ã –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Å—Å—ã–ª–∫—É –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ –ø–∏—Å—å–º–∞</li>
          </ul>
        </div>

        <div class="auth-help-warning">
          <p class="auth-help-warning-text">
            <strong>‚ö†Ô∏è –í–ê–ñ–ù–û:</strong> –ï—Å–ª–∏ –≤—ã –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∏—Å–µ–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>–°–ê–ú–û–ï –ù–û–í–û–ï</strong>. –ö–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ –æ—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ!
          </p>
        </div>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</p>
          <ul class="auth-help-list">
            <li><strong>–£–¥–∞–ª–∏—Ç–µ –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –ø–∏—Å—å–º–∞</strong> —Å –≤–æ–ª—à–µ–±–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏</li>
            <li>–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É <strong>–û–î–ò–ù –†–ê–ó</strong></li>
            <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –ø–∏—Å—å–º–∞ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –°–ø–∞–º, –ü—Ä–æ–º–æ, –û–±–Ω–æ–≤–ª–µ–Ω–∏—è)</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>—Å–∞–º—É—é —Å–≤–µ–∂—É—é</strong> —Å—Å—ã–ª–∫—É</li>
          </ul>
        </div>

        <div class="auth-help-actions">
          <button class="auth-help-btn auth-help-btn-primary" onclick="location.href='/test-no-elem/'">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É</button>
          <a href="/login/" class="auth-help-btn auth-help-btn-secondary">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</a>
        </div>
      `,

      'vpn_cloudflare': `
        <h3 class="auth-help-title">üîí –í–æ–∑–º–æ–∂–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ VPN/Cloudflare</h3>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</p>
          <ul class="auth-help-list">
            <li>VPN –∏–ª–∏ proxy —Å–µ—Ä–≤–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è Cloudflare –∑–∞—â–∏—Ç–æ–π</li>
            <li>IP-–∞–¥—Ä–µ—Å –ø–æ–ø–∞–ª –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑-–∑–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
            <li>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP (rate limiting)</li>
          </ul>
        </div>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</p>
          <ul class="auth-help-list">
            <li><strong>–û—Ç–∫–ª—é—á–∏—Ç–µ VPN</strong> –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞</li>
            <li>–ï—Å–ª–∏ VPN –Ω–µ–æ–±—Ö–æ–¥–∏–º ‚Äî <strong>—Å–º–µ–Ω–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</strong> (–≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É)</li>
            <li>–û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –∏ cookies –±—Ä–∞—É–∑–µ—Ä–∞</li>
            <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ <strong>–ò–Ω–∫–æ–≥–Ω–∏—Ç–æ/–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</strong></li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä</li>
          </ul>
        </div>

        <div class="auth-help-warning">
          <p class="auth-help-warning-text">
            <strong>–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –†–æ—Å—Å–∏–∏:</strong> –ù–µ–∫–æ—Ç–æ—Ä—ã–µ VPN-—Å–µ—Ä–≤–µ—Ä—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è Google –∏ Facebook. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä—ã –≤ –ï–≤—Ä–æ–ø–µ (–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã, –ì–µ—Ä–º–∞–Ω–∏—è) –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥.
          </p>
        </div>

        <div class="auth-help-actions">
          <button class="auth-help-btn auth-help-btn-primary" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          <a href="/login/" class="auth-help-btn auth-help-btn-secondary">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</a>
        </div>
      `,

      'generic_timeout': `
        <h3 class="auth-help-title">‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</h3>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?</p>
          <ul class="auth-help-list">
            <li>–ú–µ–¥–ª–µ–Ω–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
            <li>VPN –∑–∞–º–µ–¥–ª—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</li>
            <li>–ü—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</li>
          </ul>
        </div>

        <div class="auth-help-section">
          <p class="auth-help-subtitle">–ß—Ç–æ –¥–µ–ª–∞—Ç—å?</p>
          <ul class="auth-help-list">
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</li>
            <li>–û—Ç–∫–ª—é—á–∏—Ç–µ VPN (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ)</li>
            <li>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ</li>
            <li>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ (email + –ø–∞—Ä–æ–ª—å)</li>
          </ul>
        </div>

        <div class="auth-help-actions">
          <button class="auth-help-btn auth-help-btn-primary" onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          <a href="/login/" class="auth-help-btn auth-help-btn-secondary">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥</a>
        </div>
      `
    };

    return templates[type] || templates['generic_timeout'];
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Token Extraction
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function extractTokensFromHash() {
    debug('Extracting tokens from URL');
    debug('Current URL', window.location.href);
    debug('Hash fragment', window.location.hash);
    debug('Query string', window.location.search);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STEP 1: Check for Supabase errors FIRST (before looking for tokens)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const hash = window.location.hash;
    const query = window.location.search;
    const queryParams = query ? new URLSearchParams(query.substring(1)) : null;
    const hashHasError = !!(hash && hash.includes('error='));
    const queryHasError = !!(queryParams && (queryParams.get('error') || queryParams.get('error_code')));

    if (hashHasError || queryHasError) {
      debug('Supabase error detected in URL');
      const errorParams = hashHasError ? new URLSearchParams(hash.substring(1)) : queryParams;
      const errorCode = errorParams.get('error_code');
      const errorType = errorParams.get('error');
      const errorDescription = errorParams.get('error_description');

      debug('Error code', errorCode);
      debug('Error type', errorType);
      debug('Error description', errorDescription);

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // Enhanced Error Handling with Help Modal (v0.10.5)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      let userMessage;
      let helpModalType = null;

      // –ö–õ–ê–°–° 1: –û—à–∏–±–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏)
      if (errorDescription && errorDescription.includes('Error getting user email')) {
        // Facebook –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª email
        userMessage = 'Facebook –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –≤–∞—à email. –ù–∞–∂–º–∏—Ç–µ "–ß—Ç–æ –¥–µ–ª–∞—Ç—å?" –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.';
        helpModalType = 'facebook_email';
      } else if (errorCode === 'otp_expired') {
        // OTP —Å—Å—ã–ª–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∞
        userMessage = '–°—Å—ã–ª–∫–∞ –¥–ª—è –≤—Ö–æ–¥–∞ —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞–∂–º–∏—Ç–µ "–ß—Ç–æ –¥–µ–ª–∞—Ç—å?" –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.';
        helpModalType = 'otp_expired';
      } else if (errorCode === 'otp_disabled') {
        // OTP –æ—Ç–∫–ª—é—á–µ–Ω (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
        userMessage = '–í—Ö–æ–¥ –ø–æ email –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google –∏–ª–∏ Facebook.';
        helpModalType = 'vpn_cloudflare'; // –ú–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
      } else if (errorType === 'access_denied') {
        // –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω (–º–æ–∂–µ—Ç –±—ã—Ç—å VPN/Cloudflare)
        userMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –í–æ–∑–º–æ–∂–Ω–æ, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ VPN –∏–ª–∏ Cloudflare.';
        helpModalType = 'vpn_cloudflare';
      } else if (errorCode === 'unexpected_failure') {
        // –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ (—á–∞—Å—Ç–æ VPN/Cloudflare)
        userMessage = '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å VPN –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º.';
        helpModalType = 'vpn_cloudflare';
      } else {
        // –ö–õ–ê–°–° 2: Generic –æ—à–∏–±–∫–∏
        userMessage = errorDescription
          ? decodeURIComponent(errorDescription.replace(/\+/g, ' '))
          : '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.';
        helpModalType = 'generic_timeout';
      }

      // Track telemetry: auth failure (v0.10.2)
      trackTelemetry('auth_failure', {
        error_code: errorCode || errorType,
        error_message: errorDescription || userMessage,
        provider: 'unknown', // Provider unknown at error stage
        help_modal_type: helpModalType // Track which help was shown
      });

      // Show help modal after a short delay (let user see the error message first)
      if (helpModalType) {
        setTimeout(() => {
          showHelpModal(helpModalType, { errorCode, errorType, errorDescription });
        }, 1500);
      }

      throw new Error(userMessage);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STEP 2: No errors ‚Üí Extract authentication tokens
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let params;
    let source;

    // Try hash fragment first (Implicit flow)
    if (hash && hash.includes('access_token=')) {
      params = new URLSearchParams(hash.substring(1));
      source = 'hash fragment (Implicit flow)';
    }
    // Fallback to query string (PKCE flow)
    else if (window.location.search && window.location.search.includes('access_token=')) {
      params = new URLSearchParams(window.location.search.substring(1));
      source = 'query string (PKCE flow)';
    }
    else {
      throw new Error('–¢–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–æ–ª—à–µ–±–Ω—É—é —Å—Å—ã–ª–∫—É –≤ –ø–∏—Å—å–º–µ.');
    }

    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const tokenType = params.get('token_type');

    if (!accessToken) {
      throw new Error('–¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ URL');
    }

    debug('Tokens extracted successfully from ' + source);
    debug('Access token preview', accessToken.substring(0, 20) + '...');

    // Track telemetry: MagicLink clicked / OAuth callback (v0.10.2)
    trackTelemetry('magic_link_clicked', {
      has_hash: window.location.hash.includes('access_token'),
      source: source
    });

    return {
      access_token: accessToken,
      refresh_token: refreshToken,
      token_type: tokenType
    };
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // WordPress Authentication
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  async function authenticateWithWordPress(tokens) {
    debug('Calling WordPress REST API');

    const endpoint = window.location.origin + '/wp-json/supabase-bridge/v1/callback';
    debug('Endpoint', endpoint);

    // Determine registration_url with priority:
    // 1. URL query param (Magic Link - works across devices)
    // 2. localStorage (OAuth or same tab - works on same device)
    // 3. Current page path (fallback)
    const urlParams = new URLSearchParams(window.location.search);
    const registration_url = urlParams.get('registration_url') ||
                            safeStorage.getItem('registration_page_url') ||
                            window.location.pathname;

    debug('Registration URL determined', registration_url);

    // Determine landing_url for marketing analytics (v0.10.0)
    // 1. URL query param (Magic Link - works across devices)
    // 2. localStorage (OAuth - works on same device)
    // 3. null (user came directly to auth form)
    const landing_url = urlParams.get('landing_url') ||
                       safeStorage.getItem('sb_landing_url') ||
                       null;

    debug('Landing URL determined', landing_url);

    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          access_token: tokens.access_token,
          registration_url: registration_url,
          landing_url: landing_url
        }),
        credentials: 'include' // CRITICAL: Include cookies
      });

      debug('Response status', response.status);

      const data = await response.json();
      debug('Response data', data);

      // Handle duplicate callback (another tab/window already processing)
      if (response.status === 409) {
        debug('Duplicate callback detected');
        updateStatus('–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ...');
        timeoutId = setTimeout(() => {
          window.location.href = CONFIG.DEFAULT_REDIRECT;
        }, 2000);
        return null;
      }

      // Handle error responses
      if (!response.ok) {
        throw new Error(data.message || `–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (HTTP ${response.status})`);
      }

      return data;

    } catch (error) {
      debug('WordPress API error', error.message);
      throw error;
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Redirect Logic
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  function getRedirectUrl(wpResponse) {
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // PRIORITY-BASED REDIRECT LOGIC (v0.9.11)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //
    // Priority 1: Backend set redirect_url (Registration Pairs)
    //   ‚Üí User came from landing page form (e.g., /reg_ai_intro/)
    //   ‚Üí Redirect to Thank You page (regardless of NEW vs EXISTING)
    //
    // Priority 2: Return URL (General Login)
    //   ‚Üí User came from general login in menu (e.g., /test-no-elem/)
    //   ‚Üí Return to page where they came from
    //
    // Priority 3: Default fallback
    //   ‚Üí Home page or global default
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // PRIORITY 1: Check if backend set redirect_url (Registration Pairs)
    if (wpResponse && wpResponse.redirect_url) {
      // Backend found this form in Registration Pairs ‚Üí Landing page scenario
      debug('‚úì Backend set redirect_url (Landing Page Form)', wpResponse.redirect_url);
      debug('  ‚Üí Redirecting to Thank You page (user came from targeted landing)');
      return wpResponse.redirect_url;
    }

    // PRIORITY 2: No redirect_url ‚Üí General login scenario ‚Üí Use Return URL
    // Read redirect_to parameter from URL query string
    const urlParams = new URLSearchParams(window.location.search);
    let redirectTo = urlParams.get('redirect_to');

    // Fallback: Read from localStorage (saved on login page)
    if (!redirectTo) {
      redirectTo = safeStorage.getItem('login_return_url');
    }

    if (redirectTo) {
      debug('‚úì Using Return URL (General Login)', redirectTo);
      debug('  ‚Üí User came from menu login, returning to origin page');
      return redirectTo;
    }

    // PRIORITY 3: Default fallback
    debug('‚úì Using default redirect', CONFIG.DEFAULT_REDIRECT);
    debug('  ‚Üí No specific redirect found, using global default');
    return CONFIG.DEFAULT_REDIRECT;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Main Authentication Flow
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  async function processAuthentication() {
    debug('Starting authentication process');

    // Diagnostic tracking for timeout monitoring
    const diagnostics = {
      urlParsed: false,
      wpCalled: false,
      wpSuccess: false,
      redirected: false,
      error: null,
      startTime: Date.now()
    };

    // Silent timeout monitoring (20 seconds)
    let timeoutId;
    timeoutId = setTimeout(() => {
      if (!diagnostics.redirected) {
        // Callback is stuck - send telemetry
        console.error('‚ö†Ô∏è Callback timeout: redirect did not happen in 20 seconds', diagnostics);

        trackTelemetry('callback_timeout', {
          timeout_seconds: 20,
          url_parsed: diagnostics.urlParsed,
          wordpress_called: diagnostics.wpCalled,
          wordpress_success: diagnostics.wpSuccess,
          error_message: diagnostics.error || null,
          elapsed_ms: Date.now() - diagnostics.startTime,
          callback_url: window.location.href,
          referrer: document.referrer || null
        });

        // Show alternative login option with Help button (v0.10.5)
        clearInterval(dotsTimer);
      clearTimeout(timeoutId); // Cancel timeout - error already displayed
        const instantLoader = document.getElementById('instant-loader');
        if (instantLoader) {
          instantLoader.innerHTML = `
            <div style="text-align: center; max-width: 480px; padding: 40px;">
              <h2 style="color: #dc2626; font-size: 24px; margin: 0 0 20px 0; font-weight: 600;">‚ö†Ô∏è –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫</h2>
              <p style="color: #666; font-size: 16px; margin: 0 0 30px 0; line-height: 1.5;">
                –í—Ö–æ–¥ –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å VPN –∏–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º.
              </p>
              <div style="display: flex; gap: 12px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="showHelpModal('generic_timeout')" style="
                  padding: 14px 24px;
                  background: #f59e0b;
                  color: white;
                  border: none;
                  border-radius: 8px;
                  font-weight: 600;
                  font-size: 16px;
                  cursor: pointer;
                  transition: background 0.2s;
                  min-width: 140px;
                " onmouseover="this.style.background='#d97706'"
                   onmouseout="this.style.background='#f59e0b'">
                  üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å?
                </button>
                <a href="/login/" style="
                  display: inline-block;
                  padding: 14px 24px;
                  background: #2563eb;
                  color: white;
                  text-decoration: none;
                  border-radius: 8px;
                  font-weight: 600;
                  font-size: 16px;
                  transition: background 0.2s;
                  min-width: 140px;
                " onmouseover="this.style.background='#1d4ed8'"
                   onmouseout="this.style.background='#2563eb'">
                  –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
                </a>
              </div>
              <p style="margin-top: 20px; font-size: 14px; color: #666;">
                –ò–ª–∏ <a href="mailto:support@alexeykrol.com" style="color: #2563eb; text-decoration: underline;">–Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</a>
              </p>
            </div>
          `;
        }
      }
    }, 20000); // 20 seconds

    // Update instant loader content instead of hiding it (avoid flickering)
    const instantLoader = document.getElementById('instant-loader');
    const instantLoaderContent = instantLoader ? instantLoader.querySelector('div') : null;

    if (instantLoaderContent) {
      // Replace loading dots with simple message
      instantLoaderContent.innerHTML = `
        <h2 style="color: #16a34a; font-size: 24px; margin: 0; font-weight: 600;">‚úì –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
        <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;" id="instant-status">–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–∂–∫–æ.</p>
      `;
    }

    // Animated dots (shows progress without specific timing)
    let dotCount = 1;
    const dotsTimer = setInterval(() => {
      dotCount = (dotCount % 5) + 1; // 1-5 dots cycle
      const dots = '.'.repeat(dotCount);
      const instantStatus = document.getElementById('instant-status');
      if (instantStatus) {
        instantStatus.textContent = `–ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–∂–∫–æ${dots}`;
      }
    }, 400);

    try {
      // Step 1: Extract tokens from URL hash
      const tokens = extractTokensFromHash();
      diagnostics.urlParsed = true;

      // Step 2: Authenticate with WordPress
      diagnostics.wpCalled = true;
      const wpResponse = await authenticateWithWordPress(tokens);
      diagnostics.wpSuccess = true;

      // Handle duplicate callback (null response)
      if (wpResponse === null) {
        clearInterval(dotsTimer);
      clearTimeout(timeoutId); // Cancel timeout - error already displayed
        return;
      }

      // Step 3: Determine redirect URL
      const redirectUrl = getRedirectUrl(wpResponse);

      // DEBUG: Log before telemetry
      console.log('üéØ About to send auth_success telemetry:', {
        email: wpResponse.user_email,
        supabase_user_id: wpResponse.supabase_user_id,
        is_new_user: wpResponse.is_new_user,
        provider: wpResponse.provider
      });

      // Track telemetry: auth success (v0.10.2)
      // Wait for telemetry to send before redirect (with timeout)
      const telemetryPromise = trackTelemetry('auth_success', {
        email: wpResponse.user_email || null,
        supabase_user_id: wpResponse.supabase_user_id || null,
        is_new_user: wpResponse.is_new_user || false,
        provider: wpResponse.provider || 'unknown'
      });

      // Wait max 1 second for telemetry, then redirect anyway
      Promise.race([
        telemetryPromise,
        new Promise(resolve => setTimeout(resolve, 1000))
      ]).then(() => {
        // Step 4: Success! Redirect user
        debug('Redirecting to', redirectUrl);

        // Clean localStorage (no longer needed after login)
        safeStorage.removeItem('login_return_url');
        safeStorage.removeItem('registration_page_url');
        debug('Cleaned localStorage (login_return_url, registration_page_url)');

        // Clean URL hash and redirect
        clearInterval(dotsTimer);
      clearTimeout(timeoutId); // Cancel timeout - error already displayed
        diagnostics.redirected = true;
        window.location.href = redirectUrl;
      });

    } catch (error) {
      console.error('[Auth Callback] Error:', error);
      debug('Authentication failed', error.toString());
      diagnostics.error = error.message || error.toString();
      clearInterval(dotsTimer);
      clearTimeout(timeoutId); // Cancel timeout - error already displayed

      // Get registration_url to provide helpful retry link
      const urlParams = new URLSearchParams(window.location.search);
      const formPageUrl = urlParams.get('registration_url') || '/';

      // Update error message
      updateStatus('‚ö†Ô∏è ' + error.message, 'error');

      // Update retry panel with alternative login options + Help button (v0.10.5)
      const retryPanel = document.getElementById('authRetry');
      if (retryPanel) {
        // Detect error type for help modal
        const errorMsg = error.message || '';
        let helpType = 'generic_timeout';

        if (errorMsg.includes('Facebook') || errorMsg.includes('email from external')) {
          helpType = 'facebook_email';
        } else if (errorMsg.includes('—É—Å—Ç–∞—Ä–µ–ª–∞') || errorMsg.includes('expired')) {
          helpType = 'otp_expired';
        } else if (errorMsg.includes('VPN') || errorMsg.includes('Cloudflare') || errorMsg.includes('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω')) {
          helpType = 'vpn_cloudflare';
        }

        retryPanel.innerHTML = `
          <p style="color: #666; font-size: 14px; margin: 15px 0;">
            –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:
          </p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
            <button onclick="showHelpModal('${helpType}')" style="
              flex: 1;
              min-width: 140px;
              padding: 12px 20px;
              background: #f59e0b;
              color: white;
              border: none;
              border-radius: 6px;
              font-weight: 600;
              cursor: pointer;
              transition: background 0.2s;
              font-size: 14px;
            " onmouseover="this.style.background='#d97706'"
               onmouseout="this.style.background='#f59e0b'">
              üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å?
            </button>
            <a href="/login/" style="
              flex: 1;
              min-width: 140px;
              padding: 12px 20px;
              background: #2563eb;
              color: white;
              text-decoration: none;
              border-radius: 6px;
              font-weight: 600;
              transition: background 0.2s;
              text-align: center;
              font-size: 14px;
            " onmouseover="this.style.background='#1d4ed8'"
               onmouseout="this.style.background='#2563eb'">
              –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥
            </a>
          </div>
          <p style="font-size: 14px; color: #666; margin-top: 10px;">
            –ò–ª–∏ <a href="${formPageUrl}" style="color: #2563eb; text-decoration: underline;">–≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–æ—Ä–º–µ</a>
          </p>
        `;
        retryPanel.style.display = 'block';
      }
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Initialize
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  debug('Auth callback handler loaded');

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', processAuthentication);
  } else {
    processAuthentication();
  }

})();
</script>

<!--
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  Installation Complete!

  This page will now:
  1. Extract Supabase tokens from URL hash
  2. Authenticate with WordPress REST API
  3. Create WordPress session
  4. Redirect based on user type:
     - EXISTING USER (login): Return to ?redirect_to= page or default
     - NEW USER (registration): Thank You page from Registration Pairs

  URL Parameters:
  - ?redirect_to=/premium-course/ ‚Üí Returns existing user to that page

  Debug Mode:
  - Set CONFIG.DEBUG_MODE = true to see detailed logs
  - Check browser console for detailed information
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
